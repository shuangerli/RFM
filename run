#!/bin/bash
#SBATCH -N 1
#SBATCH -p RM
#SBATCH --ntasks-per-node 28
#SBATCH -t 4:00:00



if [[ $# == 0 ]]; then
		printf "Need at least 1 positional argument. Use --help to see instructions."
		exit 1
fi

#Rename the forward and reverse for later use
if [[ $1 == '-h' ]] || [[ $1 == '--help' ]]; then
	printf "\tPositional parameter 1: rep1_read1, Positional parameter 2: rep1_read2, Positional parameter 3: rep2_read1, Positional parameter 4: rep2_read2, Positional parameter 5: annotation, Positional parameter 6: ref genome, Positional parameter 7: Clipper output, Positional parameter 8: control file\n"
	printf "\t-example: Download sample files from ENCODE and run the program. Use replicate.\n"
	printf "\t-norep: Without replicate. Positional parameter 2: read1, Positional parameter 3: read2, Positional parameter 4: annotation, Positional parameter 5: ref genome, Positional parameter 6: Clipper output.\n"
	printf "\t-trim: ONLY trim the adapters with default settings. Postional parameter 1: read1, Positional parameter 2: read2.\n"
	printf "\t-peak: ONLY get the peak calling result from PureClip."
	exit 0
fi

#Cutadapt TWO ROUNDS to cut adapters
trim() {
	printf "Running cutadapt round 1..."
	cutadapt -f fastq --match-read-wildcards --times 1 -e 0.1 -O 1 --quality-cutoff 6 -m 18 -a NNNNNAGATCGGAAGAGCACACGTCTGAACTCCAGTCAC -g CTTCCGATCTACAAGTT  -g CTTCCGATCTTGGTCCT -A AACTTGTAGATCGGA -A AGGACCAAGATCGGA -A ACTTGTAGATCGGAA -A GGACCAAGATCGGAA  -A CTTGTAGATCGGAAG  -A GACCAAGATCGGAAG -A TTGTAGATCGGAAGA -A ACCAAGATCGGAAGA -A TGTAGATCGGAAGAG -A CCAAGATCGGAAGAG -A GTAGATCGGAAGAGC -A CAAGATCGGAAGAGC -A TAGATCGGAAGAGCG  -A AAGATCGGAAGAGCG -A AGATCGGAAGAGCGT  -A GATCGGAAGAGCGTC -A ATCGGAAGAGCGTCG -A TCGGAAGAGCGTCGT -A CGGAAGAGCGTCGTG -A GGAAGAGCGTCGTGT -o rep1/reads.R1.trimmed.fastq.gz -p rep1/reads.R2.trimmed.fastq.gz $FILE1 $FILE2 &> /dev/null
	cutadapt -f fastq --match-read-wildcards --times 1 -e 0.1 -O 1 --quality-cutoff 6 -m 18 -a NNNNNAGATCGGAAGAGCACACGTCTGAACTCCAGTCAC -g CTTCCGATCTACAAGTT  -g CTTCCGATCTTGGTCCT -A AACTTGTAGATCGGA -A AGGACCAAGATCGGA -A ACTTGTAGATCGGAA -A GGACCAAGATCGGAA  -A CTTGTAGATCGGAAG  -A GACCAAGATCGGAAG -A TTGTAGATCGGAAGA -A ACCAAGATCGGAAGA -A TGTAGATCGGAAGAG -A CCAAGATCGGAAGAG -A GTAGATCGGAAGAGC -A CAAGATCGGAAGAGC -A TAGATCGGAAGAGCG  -A AAGATCGGAAGAGCG -A AGATCGGAAGAGCGT  -A GATCGGAAGAGCGTC -A ATCGGAAGAGCGTCG -A TCGGAAGAGCGTCGT -A CGGAAGAGCGTCGTG -A GGAAGAGCGTCGTGT -o rep2/reads.R1.trimmed.fastq.gz -p rep2/reads.R2.trimmed.fastq.gz $FILE3 $FILE4 &> /dev/null
	printf "Running cutadapt round 2..."
	cutadapt -f fastq --match-read-wildcards --times 1 -e 0.1 -O 5 --quality-cutoff 6 -m 18 -A AACTTGTAGATCGGA -A AGGACCAAGATCGGA -A ACTTGTAGATCGGAA -A GGACCAAGATCGGAA -A CTTGTAGATCGGAAG -A GACCAAGATCGGAAG -A TTGTAGATCGGAAGA -A ACCAAGATCGGAAGA -A TGTAGATCGGAAGAG -A CCAAGATCGGAAGAG -A GTAGATCGGAAGAGC -A CAAGATCGGAAGAGC -A TAGATCGGAAGAGCG -A AAGATCGGAAGAGCG -A AGATCGGAAGAGCGT -A GATCGGAAGAGCGTC -A ATCGGAAGAGCGTCG -A TCGGAAGAGCGTCGT -A CGGAAGAGCGTCGTG -A GGAAGAGCGTCGTGT -o rep1/reads.R1.trimmed2.fastq.gz -p rep1/reads.R2.trimmed2.fastq.gz rep1/reads.R1.trimmed.fastq.gz rep1/reads.R2.trimmed.fastq.gz &> /dev/null
	cutadapt -f fastq --match-read-wildcards --times 1 -e 0.1 -O 5 --quality-cutoff 6 -m 18 -A AACTTGTAGATCGGA -A AGGACCAAGATCGGA -A ACTTGTAGATCGGAA -A GGACCAAGATCGGAA -A CTTGTAGATCGGAAG -A GACCAAGATCGGAAG -A TTGTAGATCGGAAGA -A ACCAAGATCGGAAGA -A TGTAGATCGGAAGAG -A CCAAGATCGGAAGAG -A GTAGATCGGAAGAGC -A CAAGATCGGAAGAGC -A TAGATCGGAAGAGCG -A AAGATCGGAAGAGCG -A AGATCGGAAGAGCGT -A GATCGGAAGAGCGTC -A ATCGGAAGAGCGTCG -A TCGGAAGAGCGTCGT -A CGGAAGAGCGTCGTG -A GGAAGAGCGTCGTGT -o rep2/reads.R1.trimmed2.fastq.gz -p rep2/reads.R2.trimmed2.fastq.gz rep2/reads.R1.trimmed.fastq.gz rep2/reads.R2.trimmed.fastq.gz &> /dev/null
}

#Download example files
get_sample_file() {
	mkdir rep1 rep2
	echo "Downloading Replication 1 Read1..."
	wget -O rep1/reads.R1.fastq.gz https://www.encodeproject.org/files/ENCFF173ODI/@@download/ENCFF173ODI.fastq.gz &> /dev/null
	echo "Downloading Replication 1 Read2..."
	wget -O rep1/reads.R2.fastq.gz https://www.encodeproject.org/files/ENCFF507EGU/@@download/ENCFF507EGU.fastq.gz &> /dev/null
	echo "Downloading Replication 2 Read1..."
	wget -O rep2/reads.R1.fastq.gz https://www.encodeproject.org/files/ENCFF578XQC/@@download/ENCFF578XQC.fastq.gz &> /dev/null
	echo "Downloading Replication 2 Read2..."
	wget -O rep2/reads.R2.fastq.gz https://www.encodeproject.org/files/ENCFF735QHY/@@download/ENCFF735QHY.fastq.gz &> /dev/null
	echo "Downloading annotation..."
	wget -O annotation.gtf.gz ftp://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_33/gencode.v33.primary_assembly.annotation.gtf.gz &> /dev/null
	echo "Downloading reference genome..."
	wget -O ref.GRCh38.fa.gz ftp://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_33/GRCh38.primary_assembly.genome.fa.gz &> /dev/null
	echo "Downloading Clipper result..."
	wget -O clipper.bed.gz https://www.encodeproject.org/files/ENCFF862EKD/@@download/ENCFF862EKD.bed.gz &> /dev/null
	echo "Downloading control file..."
	wget -O control.bam https://www.encodeproject.org/files/ENCFF608WNY/@@download/ENCFF608WNY.bam &> /dev/null
	echo "All download finished..."
}

#Prepare reads for UMI
prep_read_ids() {
	zcat rep1/reads.R1.trimmed2.fastq.gz > rep1/reads.R1.trimmed2.fastq
	zcat rep1/reads.R2.trimmed2.fastq.gz > rep1/reads.R2.trimmed2.fastq
	awk -v l=10 'BEGIN{OFS=FS=" "} substr($1, 1, 1) == "@" {print "@" substr($1, (l+3), 500) "_" substr($1, 2, l) " " $2 }; substr($1, 1, 1) != "@" {print}; ' rep1/reads.R1.trimmed2.fastq  | gzip > rep1/reads.R1.trimmed2.bc.fastq.gz
	awk -v l=10 'BEGIN{OFS=FS=" "} substr($1, 1, 1) == "@" {print "@" substr($1, (l+3), 500) "_" substr($1, 2, l) " " $2 }; substr($1, 1, 1) != "@" {print}; ' rep1/reads.R2.trimmed2.fastq  | gzip > rep1/reads.R2.trimmed2.bc.fastq.gz
	zcat rep2/reads.R1.trimmed2.fastq.gz > rep2/reads.R1.trimmed2.fastq
	zcat rep2/reads.R2.trimmed2.fastq.gz > rep2/reads.R2.trimmed2.fastq
	awk -v l=10 'BEGIN{OFS=FS=" "} substr($1, 1, 1) == "@" {print "@" substr($1, (l+3), 500) "_" substr($1, 2, l) " " $2 }; substr($1, 1, 1) != "@" {print}; ' rep2/reads.R1.trimmed2.fastq  | gzip > rep2/reads.R1.trimmed2.bc.fastq.gz
	awk -v l=10 'BEGIN{OFS=FS=" "} substr($1, 1, 1) == "@" {print "@" substr($1, (l+3), 500) "_" substr($1, 2, l) " " $2 }; substr($1, 1, 1) != "@" {print}; ' rep2/reads.R2.trimmed2.fastq  | gzip > rep2/reads.R2.trimmed2.bc.fastq.gz
}

#Read mapping with STAR
read_map_star() {
	mkdir genome_index
	STAR --runThreadN 10 --runMode genomeGenerate --genomeDir genome_index/ --genomeFastaFiles $REF --sjdbGTFfile $ANNO --sjdbOverhang 49
	mkdir -p rep1/STAR
	STAR --outSAMtype BAM SortedByCoordinate --runThreadN 10 --genomeDir genome_index/ --readFilesIn rep1/reads.R1.trimmed2.bc.fastq.gz rep1/reads.R2.trimmed2.bc.fastq.gz --readFilesCommand  zcat --outFilterType BySJout --outFilterMultimapNmax 1 --alignSJoverhangMin 8 --alignSJDBoverhangMin 1 --outFilterMismatchNmax 999 --outFilterMismatchNoverLmax 0.04 --scoreDelOpen -1 --alignIntronMin 20 --alignIntronMax 1000000 --alignMatesGapMax 1000000 --outFileNamePrefix rep1/STAR/ --alignEndsType EndToEnd
	mkdir -p rep2/STAR
	STAR --outSAMtype BAM SortedByCoordinate --runThreadN 10 --genomeDir genome_index/ --readFilesIn rep2/reads.R1.trimmed2.bc.fastq.gz rep2/reads.R2.trimmed2.bc.fastq.gz --readFilesCommand  zcat --outFilterType BySJout --outFilterMultimapNmax 1 --alignSJoverhangMin 8 --alignSJDBoverhangMin 1 --outFilterMismatchNmax 999 --outFilterMismatchNoverLmax 0.04 --scoreDelOpen -1 --alignIntronMin 20 --alignIntronMax 1000000 --alignMatesGapMax 1000000 --outFileNamePrefix rep2/STAR/ --alignEndsType EndToEnd
}

#samtools filtering
samtools_filter() {
	samtools index rep1/STAR/Aligned.sortedByCoord.out.bam
	samtools view -hb -f 2 rep1/STAR/Aligned.sortedByCoord.out.bam -o rep1/aligned.f.bam chr1:1 chr2:1 chr3:1 chr4:1 chr5:1 chr6:1 chr7:1 chr8:1 chr9:1 chr10:1 chr11:1 chr12:1 chr13:1 chr14:1 chr15:1 chr16:1 chr17:1 chr18:1 chr19:1 chr20:1 chr21:1 chr22:1 chrX:1 chrY:1
	samtools index rep1/aligned.f.bam
	samtools index rep2/STAR/Aligned.sortedByCoord.out.bam
	samtools view -hb -f 2 rep2/STAR/Aligned.sortedByCoord.out.bam -o rep2/aligned.f.bam chr1:1 chr2:1 chr3:1 chr4:1 chr5:1 chr6:1 chr7:1 chr8:1 chr9:1 chr10:1 chr11:1 chr12:1 chr13:1 chr14:1 chr15:1 chr16:1 chr17:1 chr18:1 chr19:1 chr20:1 chr21:1 chr22:1 chrX:1 chrY:1
	samtools index rep2/aligned.f.bam
}

#PCR duplicate removal using UMI
pcr_dup_rem() {
	umi_tools dedup -I rep1/aligned.f.bam --paired -S rep1/aligned.f.duplRm.bam
	umi_tools dedup -I rep2/aligned.f.bam --paired -S rep2/aligned.f.duplRm.bam
}

#Quality control
qc() {
	mkdir fastqc_result
	fastqc -o fastqc_result/ aligned.f.duplRm.pooled.R2.bam
}

clam() {
	CLAM realigner -i $CONTROL -o ./control/ --read-tagger-method start --retag --strandness opposite
	CLAM realigner -i aligned.f.duplRm.rep1.bam -o ./rep1/ ----read-tagger-method start --retag  --strandness opposite
	CLAM realigner -i aligned.f.duplRm.rep2.bam -o ./rep2/ --read-tagger-method start --retag  --strandness opposite
	CLAM peakcaller -i rep1/unique.sorted.bam,rep2/unique.sorted.bam rep1/realigned.sorted.bam,rep2/realigned.sorted.bam -c control/unique.sorted.bam control/realigned.sorted.bam -o peak --unstranded --binsize 100 --unstranded --gtf ./gencode.v33.primary_assembly.annotation.gtf 
}

intersection() {
	bedtools intersect -a narrow_peak.combined.bed -b $CLIPPER >Z.bed
}

pras() {
	python src/script/PRAS_1.0.py -g $ANNO -t example_data/IDs.txt -i intersect.bed -m check -s transcript -a Output.txt -w 10 -c 500 -p OutData
	python src/PRASScore.py
	bash ScoreCommand.txt
}


#Load all module required
module load cutadapt/1.16
module load samtools
module load fastqc
module load staraligner
module load bedtools

if [[ $1 == '-example' ]]; then
	echo "Will download sample file and run the whole script."
	get_sample_file
	FILE1=rep1/reads.R1.fastq.gz
	FILE2=rep1/reads.R2.fastq.gz
	FILE3=rep2/reads.R1.fastq.gz
	FILE4=rep2/reads.R2.fastq.gz
	ANNO=annotation.gtf.gz
	REF=ref.GRCh38.fa.gz
	CLIPPER=clipper.bed.gz
	CONTROL=control.bam
	trim
	prep_read_ids
	read_map_star
	samtools_filter
	pcr_dup_rem
	clam
	intersection
	pras
	exit 0
fi

if [[ $1 == '-trim' ]]; then
	FILE1=$2
	FILE2=$3
	trim
	exit 0
fi

if [[ $# == 7 ]]; then
	echo "Using user provided info."
	FILE1=$1
	FILE2=$2
	FILE3=$3
	FILE4=$4
	ANNO=$5
	REF=$6
	CLIPPER=$7
	CONTROL=$8
	mkdir rep1
	mkdir rep2
	trim
	prep_read_ids
	read_map_star
	samtools_filter
	pcr_dup_rem
	clam
	intersection
	pras
	exit 0
fi
